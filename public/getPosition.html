<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <body>

    <button onclick="tryGeolocation()">Try It</button>

    <div id="map"></div>

    <style>
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      var socket = io()

      //var positionHng = document.getElementById("position-hng");
      var output = document.querySelector('.output');
      var arr = document.getElementById("arrow");

      var minDist = 0.006;
      var coordinates = [];
      var coordinateIndex = 0;

      var bearing = 0;
      var currLat = 0;
      var currLong = 0;
      var map;
      var marker;
      var otherPeople = [];
      var heartOverlay;
      var polyLine;

      //Function called by async script call at bottom
      function initMap() {
        var myLatLng = {lat: -25.363, lng: 131.044};

         map = new google.maps.Map(document.getElementById('map'), {
           zoom: 13,
           center: {lat: 45.536384, lng: -73.628949}
        });

        marker = new google.maps.Marker({
          position: myLatLng,
          map: map,
          title: 'Target!'
        });

        polyLine = new google.maps.Polyline({
          strokeColor:'#f70000',
          strokeOpacity: 1.0,
          strokeWeight: 5
        });

        polyLine.setMap(map);
        var path = polyLine.getPath();
        // var simpleLatLng = new google.maps.LatLng(-34, 151)
        //  // = {lat: -25.363, lng: 131.044};
        //
        // path.push(simpleLatLng);


        var imageBounds = {
          north:45.536384,
          south:45.535557,
          west: -73.629249,
          east: -73.628002
        }


         map.addListener('click', addLatLng);


        //
        // heartOverlay = new google.maps.GroundOverlay( '/images/red_heart.png', imageBounds )
        // heartOverlay.setMap(map);

        // var imageBounds = {
        //   north: 40.773941,
        //   south: 40.712216,
        //   east: -74.12544,
        //   west: -74.22655
        // };

        heartOverlay = new google.maps.GroundOverlay('/images/red_heart.png',imageBounds);
        heartOverlay.setMap(map);

      }


      function addLatLng(event){

        console.log(event.latLng);
        console.log(event.latLng.lat);

        var path = polyLine.getPath();
        path.push(event.latLng);

      }
      //Get location of device  - navigator is just an html5 access for the browser
      var tryGeolocation = function() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
            browserGeolocationSuccess,
            browserGeolocationFail, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0});
          //  {maximumAge: 0, timeout: 5000, enableHighAccuracy: false});
        }
      };


      //Geolocation stuff
      var browserGeolocationSuccess = function(position) {
      //alert("Browser geolocation success!\n\nlat = " + position.coords.latitude + "\nlng = " + position.coords.longitude);
         var myLatLng = {lat: position.coords.latitude, lng: position.coords.longitude};

         currLat = position.coords.latitude;
         currLong = position.coords.longitude;

          //update google map with position

          map.panTo(myLatLng)
          map.setZoom(18)


          marker.setMap(null)

          marker = new google.maps.Marker({
            position: myLatLng,
            title: 'Your Position!',
            icon:"/images/dot_marker_blue.png"
          });

          marker.setMap(map)

          socket.emit("update-coordinates", myLatLng)

      };

      //Process errors for geoloc
      var browserGeolocationFail = function(error) {
        switch (error.code) {
          case error.TIMEOUT:
            alert("Browser geolocation error !\n\nTimeout.");
            break;
          case error.PERMISSION_DENIED:
            alert("Permission Denied");
            break;
          case error.POSITION_UNAVAILABLE:
            alert("Browser geolocation error !\n\nPosition unavailable AGAIN");
            break;
        }
      };


      socket.on('connect', function() {
          socket.emit('new-client', 'mobile')
          console.log('check 2', socket.connected);
      })


      socket.on("receive-other-coordinates", function(coords){
        //this should be done on the Server
        //this function should just receive a list of coordinates, and draw a line of them
        //

        var sID = this.id
        var formattedCoords = JSON.stringify(coords)
        console.log(formattedCoords + ", " + sID)

        //If we don't have this ID already
        var exists = false
        for( var i=0; i < otherPeople.length; i ++){

          //if we find a match
          if(otherPeople[i].id === this.id){
              otherPeople[i].marker.setMap(null)

              //update coordinates of marker
              otherPeople[i].marker =  new google.maps.Marker({
                position: coords,
                title: 'Position of ' + this.id,
                icon:"/images/dot_marker_gray.png"

              });

              otherPeople[i].marker.setMap(map)

              otherPeople[i].lat = coords.lat
              otherPeople[i].lng = coords.lng
              exists = true
              console.log("updating marker")
          }
        }

        if(exists == false){
          var person = {id:this.id, lat:coords.lat, lng:coords.lng, marker:null}
          person.marker = new google.maps.Marker({
            position: coords,
            title: 'Position of ' + this.id,
            icon:"/images/dot_marker_gray.png"
          });
          person.marker.setMap(map)
          console.log("adding new marker")
          otherPeople.push(person)
        }

        var path = polyLine.getPath();
        // path.clear()

        for(var i=0; i<otherPeople.length; i ++){
          // var simpleLatLng = new google.maps.LatLng(-34, 151)
          //  // = {lat: -25.363, lng: 131.044};
          //
          // path.push(simpleLatLng);
           var ll =  new google.maps.LatLng(otherPeople[i].lat,otherPeople[i].lng);
           console.log(ll);
           path.push(ll);
        }

        //every time this is updated re-draw the polyline from scratch


    })



      // socket.emit('reset-sequence')


    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDOkPz6eU_-nO5OKT_Yhv1Rkxu-gOEwKwU&callback=initMap">
    </script>



  </body>
</html>
